<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <title>Danh sách bệnh nhân chờ mổ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            overflow: hidden;
        }

        h2 {
            text-align: center;
            color: #2B6EFF;
            margin: 1.5em 0 0 0;
            padding-bottom: 20px;
            font-size: 52px; /* Kích cỡ chữ tiêu đề */
        }

        table {
            margin-top: 1em;
            border-collapse: collapse;
            width: 100%;
            font-size: 26px; /* Kích cỡ chữ bảng danh sách */
        }

        th, td {
            border: 1px solid #3c568e;
            padding: 16px 4px;
            text-align: center;
        }

        td {
            color: #0037ae;
            font-weight: bold;
        }

        th {
            background-color: #2B6EFF;
            padding: 10px 0;
        }

        #title {
            text-align: center;
            color: #fff;
        }

        #updateList {
            text-align: center;
            font-weight: 500;
        }

        #updateList > p {
            color: #2B6EFF;
            margin: 0;
            padding-bottom: 10px;
        }

        #countdown {
            color: #FE0000;
        }

        .ads {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 100vw;
            max-height: 100vh;
            object-fit: contain;
            z-index: 9999;
        }

        #overlayBlur {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(232, 232, 232, 0.1);
            z-index: 999;
            display: none;
        }

    </style>
</head>
<body>
    <div id="overlayBlur"></div>

    <div id="clickToStart" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#000a;color:#fff;display:flex;align-items:center;justify-content:center;font-size:24px;z-index:99999;">
        Bấm vào màn hình để bật tiếng cho video
    </div>
    <h2>Danh sách bệnh nhân chờ mổ</h2>

    <div id="data">Đang tải dữ liệu...</div>

    <!-- Thêm cả ảnh và video vào vùng quảng cáo -->
    <div id="ads" style="display:none; text-align:center;">
        <img id="adImage" class="ads" style="display:none;" />
        <video id="adVideo" class="ads" muted autoplay playsinline style="display:none;"></video>
    </div>

    <script>
        // Kết nối tới google sheet
        const sheetId = '1Axve1izrC6K_FMzmYI1o9KKHVp4jLA9tLBWxcrAdUx4'; // Lấy từ link chia sẻ sheet ( nằm giữa d/ và /edit)
        const sheetName = 'DS_CHO_MO'; // Tên sheet
        const range = 'A3:G50'; // Vùng lấy dữ liệu
        const apiKey = 'AIzaSyBBKTwrTqR-NU5XiMDL9XRVVOLjiF62L1I'; // Truy cập https://console.cloud.google.com/?hl=vi -> Trong Quick access chọn APIs & Services -> Chọn Credentials -> Tìm API key và bấm vào Show key

        const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetName}!${range}?key=${apiKey}`; // Giữ nguyên không đổi

        // Khai báo biến
        var countdown = 9;
        var globalData = [];
        var currentIndex = 1;
        var pageSize = 10; // Số lượng dòng hiển thị trên 1 trang
        var displayTime = 0;
        var maxDisplayTime = 30; // Sau ... giây hiển thị danh sách mổ thì sẽ hiển thị quảng cáo
        var adsDisplayTime = 10; // Số giây hiển thị giữa mỗi quảng cáo
        var inAdsMode = false;
        const imgLength = 10; // Số lượng hình ảnh/video trong file assests/files

        // Bật tiếng cho video
        document.getElementById("clickToStart").addEventListener("click", () => {
            document.getElementById("adVideo").muted = false;
            document.getElementById("clickToStart").style.display = "none";
        });

        // Lấy tất cả tên file từ file assests/files (bao gồm cả ảnh và video)
        function getAdFiles() {
            const adFiles = [];
            const fileBasePath = "./assets/files/";
            const fileCount = imgLength;

            const extensions = ['jpg', 'jpeg', 'png', 'mp4', 'mkv', 'webm', 'mp3'];

            for (let i = 1; i <= fileCount; i++) {
                for (let ext of extensions) {
                    adFiles.push(`${fileBasePath}${i}.${ext}`);
                }
            }

            return adFiles;
        }

        // Hàm kiểm tra file có tồn tại không
        function checkFileExists(url) {
            return new Promise((resolve) => {
                const ext = url.split('.').pop().toLowerCase();
                const isVideoOrAudio = ['mp4', 'mkv', 'webm', 'mp3'].includes(ext);

                const element = isVideoOrAudio ? document.createElement('video') : document.createElement('img');
                element.src = url;

                // Khi load thành công, file tồn tại
                element.onload = () => resolve(true);
                element.onerror = () => resolve(false);

                // Với video/audio cần thêm lắng nghe metadata (đảm bảo nó có file)
                if (isVideoOrAudio) {
                    element.onloadedmetadata = () => resolve(true);
                }
            });
        }

        // Hàm lấy dữ liệu từ google sheet
        async function getData() {
            try {
                const response = await fetch(url);
                const data = await response.json();

                if (!data.values) {
                    document.getElementById('data').textContent = 'Không có dữ liệu.';
                    return;
                }

                globalData = data.values;
            } catch (error) {
                console.error('Lỗi khi tải dữ liệu:', error);
                document.getElementById('data').textContent = 'Lỗi khi tải dữ liệu.';
            }
        }

        // Hàm hiển thị danh sách mổ
        function loadData() {
            if(globalData.length == 0) return;

            const rows = globalData;
            let html = '<table>';

            // Header
            html += '<thead><tr>' + rows[0].map(cell => `<th id="title">${cell}</th>`).join('') + '</tr></thead>';

            // Body
            html += '<tbody>';

            // Hiển thị 10 dòng tiếp theo
            const end = Math.min(currentIndex + pageSize, rows.length);
            for (let i = currentIndex; i < end; i++) {
                const row = rows[i];
                html += `<tr>` + row.map(cell => `<td>${cell || ''}</td>`).join('') + '</tr>';
            }

            html += '</tbody></table>';
            document.getElementById('data').innerHTML = html;

            // Cập nhật chỉ số hiển thị tiếp theo
            currentIndex = end;
        }

        // Hàm hiển thị dữ liệu
        function showData() {
            document.querySelector('h2').style.display = "block";
            document.getElementById("ads").style.display = "none";
            document.getElementById("data").style.display = "block";
        }

        // Hàm hiển thị quảng cáo (có cả ảnh và video)
        async function showAds() {
            document.querySelector('h2').style.display = "none";
            document.getElementById("data").style.display = "none";
            document.getElementById("ads").style.display = "block";
            document.getElementById("overlayBlur").style.display = "block";

            const adImage = document.getElementById("adImage");
            const adVideo = document.getElementById("adVideo");

            const files = getAdFiles();
            const validFiles = [];

            for (let file of files) {
                if (await checkFileExists(file)) {
                    validFiles.push(file);
                }
            }

            if (validFiles.length === 0) {
                console.log("Không có quảng cáo nào hợp lệ.");
                showData();
                inAdsMode = false;
                displayTime = 0;
                return;
            }

            let index = 0;

            async function playNext() {
                if (index >= validFiles.length) {
                    // Đã chiếu xong tất cả, quay về danh sách mổ
                    adImage.style.display = "none";
                    adVideo.pause();
                    adVideo.style.display = "none";
                    document.getElementById("overlayBlur").style.display = "none";
                    inAdsMode = false;
                    displayTime = 0;
                    currentIndex = 1;
                    loadData();
                    showData();
                    return;
                }

                const file = validFiles[index];
                const isVideo = file.endsWith(".mp4") || file.endsWith(".webm") || file.endsWith(".mkv");

                if (isVideo) {
                    adImage.style.display = "none";
                    adVideo.style.display = "block";
                    adVideo.src = file;
                    adVideo.play();

                    adVideo.onended = () => {
                        index++;
                        playNext();
                    };
                } else {
                    adVideo.pause();
                    adVideo.style.display = "none";
                    adImage.style.display = "block";
                    adImage.src = file;

                    setTimeout(() => {
                        index++;
                        playNext();
                    }, adsDisplayTime * 1000);
                }
            }

            playNext();
        }

        // Gọi hàm lần đầu chạy
        (async () => {
            await getData();
            loadData();
        })();

        // Cập nhật dữ liệu sau mỗi giây, sau một thời gian thì hiển thị quảng cáo
        setInterval(async () => {
            displayTime++;

            if (inAdsMode) return;

            if (displayTime >= maxDisplayTime) {
                inAdsMode = true;
                displayTime = 0;
                showAds();
                return;
            }

            if (displayTime % 15 === 0) {
                if (currentIndex >= globalData.length) {
                    currentIndex = 1;
                    await getData();
                }
                loadData();
            }
        }, 1000);
    </script>
</body>
</html>
